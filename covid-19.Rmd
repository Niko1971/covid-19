---
title: "COVID-19 monitor"
output: 
  flexdashboard::flex_dashboard:
    theme: lumen
    orientation: rows
    logo: logo.png
    source_code: embed
    social: ["twitter"]
    css: styles.css
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard) ; library(shiny) ; library(tidyverse) ; library(httr) ; library(readxl) ;  library(sf) ;  library(htmlwidgets) ; library(htmltools) ; library(leaflet) ; library(leaflet.extras) ; library(DT) ; library(scales) ; library(classInt)

# Data published by Public Health England 
# https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases

# Total confirmed cases for countries of the UK and total deaths in the UK
# URL: https://www.arcgis.com/home/item.html?id=bc8ee90225644ef7a6f4dd1b13ea1d67
url <- "https://www.arcgis.com/sharing/rest/content/items/bc8ee90225644ef7a6f4dd1b13ea1d67/data"
GET(url, write_disk(tmp <- tempfile(fileext = ".xlsx")))
daily_indicators <- read_xlsx(tmp) %>% 
  mutate(DateVal = as.Date(DateVal, format = "%d/%m/%y"))

# Confirmed cases by country
cases_by_country <- tibble(
  area_code = c("N92000002", "S92000003", "W92000004"),
  TotalCases = c(daily_indicators$NICases, daily_indicators$ScotlandCases, daily_indicators$WalesCases)
)

# Time series of daily confirmed cases in the UK
# URL: https://www.arcgis.com/home/item.html?id=e5fd11150d274bebaaf8fe2a7a2bda11
url <- "https://www.arcgis.com/sharing/rest/content/items/e5fd11150d274bebaaf8fe2a7a2bda11/data"
GET(url, write_disk(tmp <- tempfile(fileext = ".xlsx")))
daily_cases <- read_xlsx(tmp) %>% 
  mutate(DateVal = as.Date(DateVal, format = "%d/%m/%y"))

# Total confirmed cases by Upper Tier Local Authority in England
# URL: https://www.arcgis.com/home/item.html?id=b684319181f94875a6879bbc833ca3a6
utla_cases <- read_csv("https://www.arcgis.com/sharing/rest/content/items/b684319181f94875a6879bbc833ca3a6/data") %>% 
  select(area_code = GSS_CD, TotalCases) %>% 
  bind_rows(cases_by_country)

cases_by_area <- st_read("data/areas.geojson") %>% 
  left_join(utla_cases, by = "area_code") %>%
  mutate(rate = round((TotalCases/population)*100000, 1),
         cases_popup = str_c("<strong>", area_name, "</strong><br/>", TotalCases, " cases") %>% map(HTML),
         rate_popup = str_c("<strong>", area_name, "</strong><br/>", rate, " cases per 100,000 population") %>% map(HTML)) %>% 
  select(-geometry, everything())

# Time series of daily confirmed deaths in the UK
# URL: https://github.com/emmadoughty/Daily_COVID-19
daily_deaths <- read_csv("https://github.com/emmadoughty/Daily_COVID-19/raw/master/Data/COVID19_by_day.csv") %>% 
  select(Date, NewDeaths, CumDeaths) %>% 
  mutate(Date = as.Date(Date, format = "%d/%m/%Y")) %>% 
  filter(Date >= "2020-03-05") %>% # date of first UK death
  pivot_longer(-Date, names_to = "measure", values_to = "n")
```

Dashboard
=======================================================================

Row {data-height=80}
-----------------------------------------------------------------------
### 
<strong>Last updated on `r renderText({format(daily_indicators$DateVal, '%d %B %Y')})`</strong><br/>Please note that the number of confirmed coronavirus cases is likely to be much lower than the total number of cases because some people who report symptoms are not being tested.

Row
-----------------------------------------------------------------------

### New confirmed UK cases
```{r}
valueBox(comma(pull(filter(daily_cases, DateVal == max(DateVal)), CMODateCount)))
```

### Total confirmed UK cases
```{r}
valueBox(comma(max(daily_cases$CumCases)))
```

### New confirmed UK deaths
```{r}
valueBox(comma(pull(filter(daily_deaths, measure == "NewDeaths", Date == max(Date)), n)))
```

### Total confirmed UK deaths
```{r}
valueBox(comma(daily_indicators$TotalUKDeaths))
```

Row {data-height=300}
-------------------------------------

### Daily confirmed cases
```{r}
renderPlot({
  ggplot(daily_cases, aes(x = DateVal, y = CMODateCount)) +
  geom_col(fill = "#57AACB") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_x_date(expand = c(0.005, 0.005), date_labels = "%d-%b") +
  scale_y_continuous(expand = c(0.005, 0.005), position = "right") +
  labs(x = NULL, y = NULL, title = NULL, subtitle = NULL,
       caption = "Source: Public Health England") +
  theme_minimal(base_size = 16) +
  theme(plot.margin = unit(rep(0.5, 4), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15))) 
}, execOnResize = TRUE)
```

### Cumulative confirmed cases
```{r}
renderPlot({
  ggplot(daily_cases, aes(x = DateVal, y = CumCases)) +
  geom_line(colour = "#57AACB", size = 1) +
  geom_point(colour = "#57AACB", size = 2) +
  scale_y_continuous(labels = comma, expand = c(0.005, 0.005), sec.axis = sec_axis(~ ., breaks = max(daily_cases$CumCases), labels = comma)) +
  scale_x_date(expand = c(0.005, 0.1), date_labels = "%d-%b") +
  geom_hline(yintercept = 0, size = 0.5, colour = "#212121") +
  labs(x = NULL, y = NULL, title = NULL, subtitle = NULL,
       caption = "Source: Public Health England") +
  theme_minimal(base_size = 16) +
  theme(plot.margin = unit(rep(0.5, 4), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15))) +
    expand_limits(y = c(0,max(daily_cases$CumCases)*1.01))
}, execOnResize = TRUE)
```

### Daily and cumulative confirmed deaths
```{r}
renderPlot({
  ggplot(data = filter(daily_deaths, measure == "NewDeaths"), aes(x = Date, y = n)) +
  geom_col(data = filter(daily_deaths, measure == "CumDeaths"), fill = "#c0dfec") +
  geom_col(fill = "#57AACB") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_x_date(expand = c(0.005, 0.005), date_labels = "%d-%b") +
  scale_y_continuous(expand = c(0.005, 0.005), position = "right") +
  labs(x = NULL, y = NULL, title = NULL, subtitle = NULL,
       caption = "Source: Public Health England") +
  theme_minimal(base_size = 16) +
  theme(plot.margin = unit(rep(0.5, 4), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15)))
}, execOnResize = TRUE)
```

Row
-------------------------------------

### Confirmed cases by country / UTLA in England
```{r}
renderLeaflet({
  leaflet() %>%
    setView(-3, 54.3, zoom = 5) %>% 
    addTiles(urlTemplate = "",
           attribution = '<a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data © Crown copyright and database right (2020)</a> | Data: <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>', options = providerTileOptions(minZoom = 5, maxZoom = 9)) %>%
    addPolygons(data = cases_by_area, fillColor = "#EAEAEA", fillOpacity = 0.3, weight = 1, color = "#bdbdbd") %>% 
    # exclude proportional symbols without confirmed cases
    addCircleMarkers(data = filter(cases_by_area, rate != 0), lng = ~long, lat = ~lat, radius = ~sqrt(TotalCases), fillColor = "#57AACB", fillOpacity = 0.8, weight = 1, color = "#FFFFFF", opacity = 1, label = ~cases_popup) %>% 
    addFullscreenControl() %>% 
    addResetMapButton() %>% 
    onRender(
    "function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}",
    paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))
})
```

### Rate of confirmed cases by country / UTLA in England
```{r}
renderLeaflet({
  breaks <- classIntervals(cases_by_area$rate, n = 5, style = "jenks")$brks
  pal <- colorBin(palette = "Blues", domain = NULL, bins = breaks, na.color = "#FFFFFF")
  
  leaflet(data = filter(cases_by_area, rate != 0)) %>%
    setView(-3, 54.3, zoom = 5) %>% 
    addTiles(urlTemplate = "", attribution = '<a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data © Crown copyright and database right (2020)</a> | Data: <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>', options = providerTileOptions(minZoom = 5, maxZoom = 9)) %>%
    # areas without confirmed cases
    addPolygons(data = filter(cases_by_area, rate == 0), fillColor = "#EAEAEA", fillOpacity = 0.3, weight = 1, color = "#bdbdbd", label = ~rate_popup, labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "15px", direction = "auto"), highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE)) %>% 
    addPolygons(fillColor = ~pal(rate), fillOpacity = 0.8, smoothFactor = 0.5, stroke = TRUE, weight = 1, color = "#bdbdbd", opacity = 1, label = ~rate_popup, labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "15px", direction = "auto"), highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE)) %>% 
    addLegend(pal = pal, values = ~rate, opacity = 0.7, title = "Cases per 100,000 population", position = "bottomright") %>% 
    addFullscreenControl() %>% 
    addResetMapButton() %>% 
    onRender(
      "function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}",
      paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))
})
```

About {data-icon="fa-info-circle"}
=======================================================================

### 

<div class = "about">
<p>This dashboard visualises daily confirmed coronavirus cases and deaths in the UK published by <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>.</p>
<p>Further information about Coronavirus (COVID-19) can be found at: <a href="https://www.gov.uk/coronavirus" target="_blank">https://www.gov.uk/coronavirus</a></p>
<strong>Data sources</strong>
 <ul>
    <li><a href="https://www.arcgis.com/home/item.html?id=bc8ee90225644ef7a6f4dd1b13ea1d67" target="_blank">Total confirmed cases for countries of the UK and total deaths in the UK</a></li>
    <li><a href="https://www.arcgis.com/home/item.html?id=e5fd11150d274bebaaf8fe2a7a2bda11" target="_blank">Time series of daily confirmed cases in the UK</a></li>
    <li><a href="https://www.arcgis.com/home/item.html?id=b684319181f94875a6879bbc833ca3a6" target="_blank">Total confirmed cases by Upper Tier Local Authority in England</a></li>
    <li><a href="https://github.com/emmadoughty/Daily_COVID-19" target="_blank">Time series of daily confirmed deaths in the UK</a>
</li>
 </ul>
<strong>Credits</strong>
<p>This application was built using the <a href="https://cran.r-project.org" target="_blank">R</a> <a href="https://cran.r-project.org/web/packages/shiny/index.html" target="_blank">Shiny</a> package.</p>
</div>