---
title: "COVID-19 UK monitor"
output: 
  flexdashboard::flex_dashboard:
    theme: lumen
    orientation: rows
    vertical_layout: fill
    logo: logo.png
    source_code: https://github.com/traffordDataLab/covid-19
    social: ["twitter"]
    css: styles.css
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard) ; library(shiny) ; library(tidyverse) ; library(httr) ; library(readxl) ;  library(sf) ;  library(htmlwidgets) ; library(htmltools) ; library(leaflet) ; library(leaflet.extras) ; library(scales) ; library(classInt) ; library(plotly) ; library(ggrepel)

source("load_data.R")
```

Cases 
=======================================================================

Row
-------------------------------------

### <strong>New confirmed UK cases</strong><br/><small>as of `r format(daily_indicators$DateVal, '%d %B %Y')`</small>
```{r}
valueBox(comma(pull(filter(daily_cases, DateVal == max(DateVal)), CMODateCount)), color = "#39809E")
```

### <strong>Total confirmed UK cases</strong><br/><small>as of `r format(daily_indicators$DateVal, '%d %B %Y')`</small>
```{r}
valueBox(comma(max(daily_cases$CumCases)), color = "#39809E")
```

Row
-------------------------------------

### Daily confirmed cases
```{r}
renderPlotly({
  p <- ggplot(daily_cases, aes(x = DateVal, y = CMODateCount, text = paste0("<b>", comma(CMODateCount, accuracy = 1), "</b> cases<br>", format(DateVal, "%d %B")))) +
    geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +
    geom_col(fill = "#39809E") +
    scale_x_date(expand = c(0.005, 0.005), date_labels = "%d-%b") +
    scale_y_continuous(expand = c(0.005, 0.005), labels = comma) +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = NULL) +
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank()) 
  
  ggplotly(p, tooltip = "text") %>%
    config(displayModeBar = FALSE) %>% 
    layout(xaxis = list(fixedrange = TRUE)) %>%
    layout(yaxis = list(fixedrange = TRUE))  
})
```

> <br/>**Notes**: 1) Confirmed cases are recorded up to 9am on `r format(daily_indicators$DateVal, '%d %B %Y')`. 2) The date of a case refers to the day the results of a test were confirmed not the day the test was performed. 3) The number of *confirmed* cases is likely to be much lower than the *total* number of cases because not all people who report symptoms of coronavirus are not being tested.<br/>**Source**: [Public Health England](https://www.arcgis.com/home/item.html?id=e5fd11150d274bebaaf8fe2a7a2bda11)
 
### Cumulative confirmed cases
```{r}
fillCol(flex = c(NA, 1),
        radioButtons("cases_scale", label = NULL, choices = c("Linear", "Logarithmic"), selected = "Linear", inline = TRUE),
        plotlyOutput("cases_plot", height = "100%")
        )

output$cases_plot <- renderPlotly({
  p <- ggplot(daily_cases, aes(x = DateVal, y = CumCases, group = 1, text = paste0("<b>", comma(CumCases, accuracy = 1), "</b> cases<br>", format(DateVal, "%d %B")))) +
    geom_line(colour = "#39809E", size = 1) +
    scale_x_date(expand = c(0.005, 0.4), date_labels = "%d-%b") +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = NULL) +
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank())
  
  if (input$cases_scale == "Linear") {
    
    p <- p + geom_hline(yintercept = 0, size = 0.3, colour = "#333333") + scale_y_continuous(expand = c(0.005, 0.005), labels = comma)
    
    } else {
      
      p <- p + geom_hline(yintercept = 1, size = 0.3, colour = "#333333") + scale_y_continuous(trans = "log10", expand = c(0.005, 0.005), labels = comma_format(accuracy = 1))
      
    }
  
  ggplotly(p, tooltip = "text") %>%
    config(displayModeBar = FALSE) %>% 
    layout(xaxis = list(fixedrange = TRUE)) %>%
    layout(yaxis = list(fixedrange = TRUE)) 
  
})
```

> <br/>**Notes**: Logarithmic scales represent an exponential curve as a straight line. The steeper the line the faster the rate of growth.<br/>**Source**: [Public Health England](https://www.arcgis.com/home/item.html?id=e5fd11150d274bebaaf8fe2a7a2bda11)

Deaths 
=======================================================================

Row
-------------------------------------

### <strong>New confirmed UK deaths</strong><br/><small>as of `r format(max(daily_deaths$Date), '%d %B %Y')`</small>
```{r}
valueBox(comma(pull(filter(daily_deaths, Date == max(Date)), NewDeaths)), color = "#8D2313")
```

### <strong>Total confirmed UK deaths</strong><br/><small>as of `r format(max(daily_deaths$Date), '%d %B %Y')`</small>
```{r}
valueBox(comma(max(daily_deaths$CumDeaths)), color = "#8D2313")
```

Row
-------------------------------------

### Daily confirmed deaths
```{r}
renderPlotly({
  p <- ggplot(daily_deaths, aes(x = Date, y = NewDeaths, text = paste0("<b>", comma(NewDeaths, accuracy = 1), "</b> deaths<br>", format(Date, "%d %B")))) +
    geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +
    geom_col(fill = "#8D2313") +
    scale_x_date(expand = c(0.005, 0.005), date_labels = "%d-%b") +
    scale_y_continuous(expand = c(0.005, 0.005), labels = comma) +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = NULL) +
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank()) 
  
  ggplotly(p, tooltip = "text") %>%
    config(displayModeBar = FALSE) %>% 
    layout(xaxis = list(fixedrange = TRUE)) %>%
    layout(yaxis = list(fixedrange = TRUE)) 
})
```

> <br/>**Notes**: 1) Deaths are recorded up to 5pm on `r format(max(daily_deaths$Date)-1, '%d %B %Y')`. 2) The date of a death refers to the day the death was reported not the actual date of the death. 3) The number of deaths only includes patients who tested positive for coronavirus and died in a UK hospital. Deaths that occurred in the community in England and Wales are included in provisional figures published by the [Office for National Statistics](https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/datasets/weeklyprovisionalfiguresondeathsregisteredinenglandandwales) on a weekly basis.<br/>**Source**: [Public Health England](https://fingertips.phe.org.uk/documents/Historic%20COVID-19%20Dashboard%20Data.xlsx)

### Cumulative confirmed deaths
```{r}
fillCol(flex = c(NA, 1),
        radioButtons("deaths_scale", label = NULL, choices = c("Linear", "Logarithmic"), selected = "Linear", inline = TRUE),
        plotlyOutput("deaths_plot", height = "100%")
        )

output$deaths_plot <- renderPlotly({
  if (input$deaths_scale == "Linear") {
    
    p <- ggplot(daily_deaths, aes(x = Date, y = CumDeaths, group = 1, text = paste0("<b>", comma(CumDeaths, accuracy = 1), "</b> deaths<br>", format(Date, "%d %B")))) +
    geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +  
    geom_line(colour = "#8D2313", size = 1) +
    scale_x_date(expand = c(0.005, 0.4), date_labels = "%d-%b") +
    scale_y_continuous(expand = c(0.005, 0.005), labels = comma) +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = NULL) +
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank())
    
    ggplotly(p, tooltip = "text") %>%
      config(displayModeBar = FALSE) %>% 
      layout(xaxis = list(fixedrange = TRUE)) %>%
      layout(yaxis = list(fixedrange = TRUE)) 
    
    } else {
      
      temp <- daily_deaths %>% 
        arrange(Date) %>% 
        filter(CumDeaths > 0) %>%
        mutate(days = as.integer(Date - min(Date)),
               doubling_2_day = 1*(1+((2^(1/2))-1))^(days),
               doubling_3_day = 1*(1+((2^(1/3))-1))^(days),
               doubling_1_week = 1*(1+((2^(1/7))-1))^(days))
      
      p <- ggplot(temp, aes(x = Date, y = CumDeaths, group = 1, 
                          text = paste0("<b>", comma(CumDeaths, accuracy = 1), "</b> deaths<br>", format(Date, "%d %B")))) +
        geom_hline(yintercept = 1, size = 0.3, colour = "#333333") +
        geom_line(colour = "#8D2313", size = 1) +
        scale_x_date(expand = c(0.005, 0.4), date_labels = "%d-%b") +
        scale_y_continuous(trans = "log10", expand = c(0.005, 0.005), labels = comma_format(accuracy = 1)) +
        geom_line(aes(x = Date, y = doubling_2_day), colour = "#bdbdbd", lty = 3) +
        geom_line(aes(x = Date, y = doubling_3_day), colour = "#bdbdbd", lty = 2) +
        geom_line(aes(x = Date, y = doubling_1_week), colour = "#bdbdbd", lty = 4) +
        labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = NULL) +
        theme_minimal() +
        theme(plot.margin = unit(rep(0.5, 4), "cm"),
              panel.grid.major.x = element_blank(),
              panel.grid.minor = element_blank())
      
      ggplotly(p, tooltip = "text") %>%
        config(displayModeBar = FALSE) %>% 
        layout(xaxis = list(fixedrange = TRUE)) %>%
        layout(yaxis = list(fixedrange = TRUE)) %>%
        style(text = "Doubling every 2 days", traces = 3) %>%
        style(text = "Doubling every 3 days", traces = 4) %>% 
        style(text = "Doubling every week", traces = 5)
      
    }

})
```

> <br/>**Notes**: Logarithmic scales represent an exponential curve as a straight line. The steeper the line the faster the rate of growth.<br/>**Source**: [Public Health England](https://fingertips.phe.org.uk/documents/Historic%20COVID-19%20Dashboard%20Data.xlsx)

Map
=======================================================================

Row
-------------------------------------

### Confirmed cases
```{r}
renderLeaflet({
  leaflet() %>%
    setView(-3, 54.3, zoom = 6) %>% 
    addTiles(urlTemplate = "",
           attribution = paste0('<a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data © Crown copyright and database right (2020)</a> | Source: <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>', ". Updated on ", format(daily_indicators$DateVal, '%d %B %Y'), "."), options = providerTileOptions(minZoom = 6, maxZoom = 10)) %>%
    addPolygons(data = cases_by_area, fillColor = "#EAEAEA", fillOpacity = 0.3, weight = 1, color = "#bdbdbd") %>% 
    addCircleMarkers(data = cases_by_area, lng = ~long, lat = ~lat, radius = ~sqrt(TotalCases), fillColor = "#39809E", fillOpacity = 0.8, weight = 1, color = "#FFFFFF", opacity = 1, label = ~cases_popup) %>%
    addFullscreenControl() %>% 
    addResetMapButton() %>% 
    onRender(
    "function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}",
    paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))
})
```

> <br/>**Notes**: City of London cases are combined with Hackney and those confirmed in Cornwall are combined with the Isles of Scilly.<br/>**Source**: [Public Health England](https://www.arcgis.com/home/item.html?id=b684319181f94875a6879bbc833ca3a6)

### Infection rate
```{r}
renderLeaflet({
  breaks <- classIntervals(cases_by_area$rate, n = 5, style = "jenks")$brks
  pal <- colorBin(palette = c("#dceef8","#b5d1e1","#8eb6ca","#669ab4","#39809e"), domain = NULL, bins = breaks, na.color = "#FFFFFF")
  
  leaflet(data = cases_by_area) %>%
    setView(-3, 54.3, zoom = 6) %>% 
    addTiles(urlTemplate = "", attribution = paste0('<a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data © Crown copyright and database right (2020)</a> | Source: <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>', ". Updated on ", format(daily_indicators$DateVal, '%d %B %Y'), "."), options = providerTileOptions(minZoom = 6, maxZoom = 10)) %>%
    addPolygons(fillColor = ~pal(rate), fillOpacity = 0.8, smoothFactor = 0.5, stroke = TRUE, weight = 1, color = "#bdbdbd", opacity = 1, label = ~rate_popup, labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "15px", direction = "auto"), highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE)) %>% 
    addLegend(pal = pal, values = ~rate, opacity = 0.7, title = "Cases per 100,000 population", position = "bottomright") %>% 
    addFullscreenControl() %>% 
    addResetMapButton() %>% 
    onRender(
      "function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}",
      paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))
})
```

> <br/>**Notes**: [Mid-2018 population estimates](https://www.nomisweb.co.uk/query/construct/summary.asp?mode=construct&version=0&dataset=2002) published by the [Office for National Statistics](https://www.ons.gov.uk/) are used as the denominator to calculate a rate of infection per 100,000 residents.<br/>**Source**: [Public Health England](https://www.arcgis.com/home/item.html?id=b684319181f94875a6879bbc833ca3a6)

International 
=======================================================================

Row
-------------------------------------

### Cumulative number of deaths
```{r}
renderPlotly({
  p <- ggplot(global_deaths, aes(x = days, y = total_deaths, color = countriesAndTerritories, label = countriesAndTerritories, group = countriesAndTerritories, text = paste0("<b>", countriesAndTerritories, "</b><br><b>", days, "</b> days", "</br><b>", comma(total_deaths), "</b> deaths"))) + 
    geom_hline(yintercept = 100, size = 0.3, colour = "#333333") +
    geom_line(size = 0.6) + 
    geom_text(data = global_deaths %>% group_by(countriesAndTerritories) %>% filter(days == max(days)) %>% ungroup(), aes(x = days, y = total_deaths), nudge_x = 0.3, nudge_y = 0.03, fontface = "bold", check_overlap = TRUE) +
    scale_colour_manual(values = c("China" = "#E58606", "France" = "#52BCA3",  "Italy" = "#99C945", "Germany" = "#CC61B0","Netherlands" = "#24796C", "South_Korea" = "#DAA51B", "Spain" = "#2F8AC4", "Sweden" = "#764E9F", "UK" = "#ED645A", "USA" = "#CC3A8E")) +
    scale_x_continuous(expand = expansion(add = c(0,1))) +
    scale_y_continuous(trans = "log10", breaks = c(100, 200, 500, 1000, 2000, 5000, 10000, 20000), limits = c(100,20000), expand = c(0.005, 0.005), labels = comma_format(accuracy = 1)) +
    labs(x = "Days since 100th death", y = NULL, title = NULL, subtitle = NULL, caption = NULL) + 
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.minor = element_blank()) +
    guides(colour = FALSE)
  
  p <- ggplotly(p, tooltip = "text") %>%
    config(displayModeBar = FALSE) %>%
    layout(xaxis = list(fixedrange = TRUE)) %>%
    layout(yaxis = list(fixedrange = TRUE)) %>% 
    hide_legend()
  
  p$x$data[[12]]$hoverinfo <- "none"
  p$x$data[[13]]$hoverinfo <- "none"
  p$x$data[[14]]$hoverinfo <- "none"
  p$x$data[[15]]$hoverinfo <- "none"
  p$x$data[[16]]$hoverinfo <- "none"
  p$x$data[[17]]$hoverinfo <- "none"
  p$x$data[[18]]$hoverinfo <- "none"
  p$x$data[[19]]$hoverinfo <- "none"
  p$x$data[[20]]$hoverinfo <- "none"
  p$x$data[[21]]$hoverinfo <- "none"
  
  p
})
```

> <br/>**Notes**: The number of days for China have been truncated to better show the change in the rate of growth amongst other countries. The chart is inspired by the [Financial Times' coronavirus trajectory tracker](https://www.ft.com/coronavirus-latest) which is built and updated by [\@jburnmurdoch](https://twitter.com/jburnmurdoch).<br/>**Source**: [European Centre for Disease Prevention and Control](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide)

### COVID-19 Government Response Stringency Index
```{r}
renderPlot({
  ggplot(stringency_index,  aes(x = date_value, y = stringency, colour = country, label = country, group = country)) +
    geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +
    geom_line(size = 0.8) +
    geom_text_repel(data = ungroup(filter(group_by(stringency_index, country), date_value == max(date_value))), aes(x = date_value, y = stringency), fontface = "bold", segment.color = NA, nudge_x = -2.5, nudge_y = 1.4) +
    scale_colour_manual(values = c("Germany" = "#CC61B0", "Italy" = "#99C945", "Spain" = "#2F8AC4", "Sweden" = "#764E9F", "UK" = "#ED645A")) +
    scale_x_date(expand = c(0.005, 0.4), date_labels = "%d-%b") +
    scale_y_continuous(expand = c(0.005, 0.005), limits = c(0,100)) +
    labs(x = NULL, y = "Stringency Index (0 = no measures)", title = NULL, subtitle = NULL, caption = NULL) + 
    theme_minimal(base_size = 16) +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          strip.text.x = element_blank(),
          axis.text.x = element_text(angle = 90, hjust = 1)) +
    guides(colour = FALSE)

})    
```

> <br/>**Notes**: The [Oxford COVID-19 Government Response Tracker (OxCGRT)](www.bsg.ox.ac.uk/covidtracker) compares government responses to the coronavirus pandemic by creating a composite index of different categories of response. A score of 0 on the Index indicates no measures have been taken.<br/>**Source**: [Blavatnik School of Government, Oxford University](https://www.bsg.ox.ac.uk/research/research-projects/oxford-covid-19-government-response-tracker).

About {data-icon="fa-info-circle"}
=======================================================================

### 

```{r}
includeHTML("about.html")
```

