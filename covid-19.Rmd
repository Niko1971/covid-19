---
title: "COVID-19 monitor"
output: 
  flexdashboard::flex_dashboard:
    theme: lumen
    orientation: rows
    logo: logo.png
    source_code: "https://github.com/trafforddatalab/covid-19"
    css: styles.css
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard) ; library(shiny) ; library(tidyverse) ; library(httr) ; library(readxl) ;  library(sf) ;  library(htmlwidgets) ; library(htmltools) ; library(leaflet) ; library(leaflet.extras) ; library(DT) ; library(scales) ; library(classInt)

source("data/load_covid19_data.R")
```

Cases
=======================================================================

Row
-----------------------------------------------------------------------

### New confirmed UK cases (`r format(daily_indicators$DateVal, '%d %B %Y')`)
```{r}
valueBox(comma(pull(filter(daily_cases, DateVal == max(DateVal)), CMODateCount)))
```

### Total confirmed UK cases (`r format(daily_indicators$DateVal, '%d %B %Y')`)
```{r}
valueBox(comma(max(daily_cases$CumCases)))
```

Row {data-height=300}
-------------------------------------

### Daily new confirmed cases
```{r}
renderPlot({
  ggplot(daily_cases, aes(x = DateVal, y = CMODateCount)) +
  geom_col(fill = "#57AACB") +
  geom_hline(yintercept = 0, size = 1, colour = "#333333") +
  scale_x_date(expand = c(0.005, 0.005), date_labels = "%d-%b") +
  scale_y_continuous(expand = c(0.005, 0.005), position = "right") +
  labs(x = NULL, y = NULL, title = NULL, subtitle = NULL,
       caption = "Source: Public Health England") +
  theme_minimal(base_size = 16) +
  theme(plot.margin = unit(rep(0.5, 4), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15))) 
}, execOnResize = TRUE)
```

### Cumulative confirmed cases
```{r}
renderPlot({
  ggplot(daily_cases, aes(x = DateVal, y = CumCases)) +
  geom_line(colour = "#57AACB", size = 1) +
  geom_point(colour = "#57AACB", size = 2) +
  scale_y_continuous(labels = comma, expand = c(0.005, 0.005), sec.axis = sec_axis(~ ., breaks = max(daily_cases$CumCases), labels = comma)) +
  scale_x_date(expand = c(0.005, 0.1), date_labels = "%d-%b") +
  geom_hline(yintercept = 0, size = 0.5, colour = "#212121") +
  labs(x = NULL, y = NULL, title = NULL, subtitle = NULL,
       caption = "Source: Public Health England") +
  theme_minimal(base_size = 16) +
  theme(plot.margin = unit(rep(0.5, 4), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15))) +
    expand_limits(y = c(0,max(daily_cases$CumCases)*1.01))
}, execOnResize = TRUE)
```

Row
-------------------------------------

### Confirmed cases by country / UTLA in England
```{r}
renderLeaflet({
  leaflet() %>%
    setView(-3, 54.3, zoom = 5) %>% 
    addTiles(urlTemplate = "",
           attribution = '<a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data © Crown copyright and database right (2020)</a> | Data: <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>') %>%
    addPolygons(data = cases_by_area, fillColor = "#EAEAEA", fillOpacity = 0.3, weight = 1, color = "#bdbdbd") %>% 
    # exclude proportional symbols without confirmed cases
    addCircleMarkers(data = filter(cases_by_area, rate != 0), lng = ~long, lat = ~lat, radius = ~sqrt(TotalCases), fillColor = "#57AACB", fillOpacity = 0.8, weight = 1, color = "#FFFFFF", opacity = 1, label = ~cases_popup) %>% 
    addFullscreenControl() %>% 
    addResetMapButton() %>% 
    onRender(
    "function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}",
    paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))
})
```

### Rate of confirmed cases by country / UTLA in England
```{r}
renderLeaflet({
  breaks <- classIntervals(cases_by_area$rate, n = 5, style = "jenks")$brks
  pal <- colorBin(palette = "Blues", domain = NULL, bins = breaks, na.color = "#FFFFFF")
  
  leaflet(data = filter(cases_by_area, rate != 0)) %>%
    setView(-3, 54.3, zoom = 5) %>% 
    addTiles(urlTemplate = "", attribution = '<a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data © Crown copyright and database right (2020)</a> | Data: <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>') %>%
    # areas without confirmed cases
    addPolygons(data = filter(cases_by_area, rate == 0), fillColor = "#EAEAEA", fillOpacity = 0.3, weight = 1, color = "#bdbdbd", label = ~rate_popup, labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "15px", direction = "auto"), highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE)) %>% 
    addPolygons(fillColor = ~pal(rate), fillOpacity = 0.8, smoothFactor = 0.5, stroke = TRUE, weight = 1, color = "#bdbdbd", opacity = 1, label = ~rate_popup, labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "15px", direction = "auto"), highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE)) %>% 
    addLegend(pal = pal, values = ~rate, opacity = 0.7, title = "Cases per 100,000 population", position = "bottomright") %>% 
    addFullscreenControl() %>% 
    addResetMapButton() %>% 
    onRender(
      "function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}",
      paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))
})
```

Deaths
=======================================================================

Row
-----------------------------------------------------------------------

### New confirmed UK deaths (`r format(max(deaths$DateRep), '%d %B %Y')`)
```{r}
valueBox(comma(pull(filter(deaths, DateRep == max(DateRep)), Deaths)))
```

### Total confirmed UK deaths (`r format(max(deaths$DateRep), '%d %B %Y')`)
```{r}
valueBox(comma(pull(filter(deaths, DateRep == max(DateRep)), CumDeaths)))
```

Row {data-height=700}
-------------------------------------

### Daily new confirmed deaths
```{r}
renderPlot({
  ggplot(deaths, aes(x = DateRep, y = Deaths)) +
    geom_col(fill = "#57AACB") +
    geom_hline(yintercept = 0, size = 1, colour = "#333333") +
    scale_x_date(expand = c(0.005, 0.005), date_labels = "%d-%b") +
    scale_y_continuous(expand = c(0.005, 0.005), position = "right") +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL,
         caption = "Source: European Center for Disease Control and Prevention") +
    theme_minimal(base_size = 16) +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15)))
}, execOnResize = TRUE)
```

### Cumulative confirmed deaths
```{r}
renderPlot({
  ggplot(deaths, aes(x = DateRep, y = CumDeaths)) +
    geom_line(colour = "#57AACB", size = 1) +
    geom_point(colour = "#57AACB", size = 2) +
    scale_y_continuous(labels = comma, expand = c(0.005, 0.005), sec.axis = sec_axis(~ ., breaks = max(deaths$CumDeaths), labels = comma)) +
    scale_x_date(expand = c(0.005, 0.1), date_labels = "%d-%b") +
    geom_hline(yintercept = 0, size = 0.5, colour = "#212121") +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL,
         caption = "Source: European Center for Disease Control and Prevention") +
    theme_minimal(base_size = 16) +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15))) +
    expand_limits(y = c(0,max(deaths$CumDeaths)*1.01))
  
}, execOnResize = TRUE)
```

About {data-icon="fa-info-circle"}
=======================================================================

###

<div class = "about">
This dashboard visualises confirmed UK cases and deaths from coronavirus (COVID-19) using data published by:     

- <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a> (last updated at 18:00 (GMT) on `r renderText({format(daily_indicators$DateVal, '%d %B %Y')})`)     
- <a href="https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide" target="_blank">European Center for Disease Control and Prevention</a> (last updated at 10:00 (CET) on `r renderText({format(max(deaths$DateRep)+1, '%d %B %Y')})`)     

Please note that the number of confirmed cases is likely to be much lower than the total number of cases because some people who report symptoms are not being tested.    

<strong>Further information about Coronavirus (COVID-19) can be found at: <a href="https://www.gov.uk/coronavirus" target="_blank">https://www.gov.uk/coronavirus</a></strong>
</div>